[phases.setup]
nixPkgs = ["busybox", "nodejs", "nodePackages.pm2"]
aptPkgs = ["ca-certificates", "curl"]

[phases.install]
# Use a single RUN command with shell script approach to ensure Bun is in PATH
cmds = [
    "curl -fsSL https://bun.sh/install | bash && source ~/.bashrc && PATH=\"$HOME/.bun/bin:$PATH\" bun install"
]

[phases.build]
# Same approach for the build phase
cmds = [
    "source ~/.bashrc && PATH=\"$HOME/.bun/bin:$PATH\" bun run build"
]

[start]
cmd = '/assets/start.sh'

[staticAssets]
"start.sh" = '''
#!/bin/bash
# Source bashrc to get Bun in PATH
source ~/.bashrc
export PATH="$HOME/.bun/bin:$PATH"

# Log Bun version for debugging
echo "Bun version: $(bun --version)"

# Run the application based on environment
if [ "$NODE_ENV" = "production" ]; then
    # Use PM2 in production
    echo "Starting in production mode with PM2..."
    pm2-runtime start pm2.config.js --env production
else
    # Use development mode
    echo "Starting in development mode..."
    bun run dev
fi
'''

"pm2.config.js" = '''
module.exports = {
  apps: [
    {
      name: 'next-app',
      script: './node_modules/.bin/next',
      args: 'start',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: process.env.PORT || 3000
      }
    }
  ]
};
'''
